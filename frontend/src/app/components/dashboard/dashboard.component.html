<div class="min-vh-100">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm border-bottom">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <h1 class="navbar-brand h3 mb-0 fw-semibold text-dark">
                    üåû Solar Investigator Dashboard
                </h1>
                <small class="text-muted ms-3">
                    AI-powered solar project management and analysis
                </small>
            </div>
            <div class="d-flex align-items-center">
                <button (click)="refresh()" class="btn btn-outline-secondary me-3" title="Refresh">
                    üîÑ Refresh
                </button>
                <button (click)="openNewInvestigationModal(newInvestigationModal)" class="btn btn-primary">
                    + New Investigation
                </button>
            </div>
        </div>
    </nav>

    <!-- Error Alert -->
    <div *ngIf="error" class="container-fluid mt-3">
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>API Error (0):</strong> {{ error }}
            <button type="button" class="btn-close" (click)="error = null"></button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button (click)="setActiveTab('investigations')" [class.active]="activeTab === 'investigations'"
                    class="nav-link">
                    üîç Investigations
                </button>
            </li>
            <li class="nav-item">
                <button (click)="setActiveTab('workorders')" [class.active]="activeTab === 'workorders'"
                    class="nav-link">
                    üìã Work Orders
                </button>
            </li>
            <li class="nav-item">
                <button (click)="setActiveTab('projects')" [class.active]="activeTab === 'projects'" class="nav-link">
                    üèóÔ∏è Projects
                </button>
            </li>
        </ul>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="text-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3 text-muted">Loading dashboard data...</p>
        </div>

        <!-- Investigations Tab -->
        <div *ngIf="activeTab === 'investigations' && !isLoading">
            <!-- Investigation List -->
            <div *ngIf="!selectedInvestigation">
                <!-- Empty State -->
                <div *ngIf="investigations.length === 0" class="text-center py-5">
                    <div style="font-size: 4rem;" class="text-muted mb-3">üîç</div>
                    <h3 class="h4 text-dark mb-3">No investigations found</h3>
                    <p class="text-muted mb-4">Start a new investigation to see results here.</p>
                    <button (click)="openNewInvestigationModal(newInvestigationModal)" class="btn btn-primary btn-lg">
                        Start Investigation
                    </button>
                </div>

                <!-- Investigation Cards -->
                <div *ngIf="investigations.length > 0" class="row g-4">
                    <div *ngFor="let investigation of investigations" class="col-md-6 col-lg-4">
                        <div (click)="selectInvestigation(investigation)" class="card h-100 investigation-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title">{{ getInvestigationTitle(investigation) }}</h5>
                                    <span [class]="'badge ' + getStatusColor(investigation.status)">
                                        {{ investigation.status | titlecase }}
                                    </span>
                                </div>

                                <div class="text-muted small mb-3">
                                    <p class="mb-1">Started: {{ formatDate(investigation.created_at) }}</p>
                                    <p class="mb-1">Usage: {{ investigation.monthly_usage }} kWh/month</p>
                                    <p class="mb-0"
                                        *ngIf="chatMessages.length > 0 && selectedInvestigation?.id === investigation.id">
                                        Messages: {{ chatMessages.length }}
                                    </p>
                                </div>

                                <!-- Progress Bar for Running Investigations -->
                                <div *ngIf="isInvestigationActive(investigation)" class="mb-3">
                                    <div class="d-flex justify-content-between small text-muted mb-1">
                                        <span>In Progress</span>
                                        <span>Processing...</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                            style="width: 45%"></div>
                                    </div>
                                </div>

                                <small class="text-muted">
                                    Click to view chat and details
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Investigation Detail View -->
            <div *ngIf="selectedInvestigation" class="card">
                <!-- Header -->
                <div class="card-header bg-light">
                    <button (click)="selectedInvestigation = null; stopChatRefresh()"
                        class="btn btn-link text-primary p-0 mb-2">
                        ‚Üê Back to Investigations
                    </button>
                    <h2 class="h4 mb-2">{{ getInvestigationTitle(selectedInvestigation) }}</h2>
                    <div class="d-flex align-items-center">
                        <span [class]="'badge me-3 ' + getStatusColor(selectedInvestigation.status)">
                            {{ selectedInvestigation.status | titlecase }}
                        </span>
                        <small class="text-muted">
                            {{ formatDate(selectedInvestigation.created_at) }}
                        </small>
                    </div>
                    <div class="mt-2 text-muted small">
                        <div>Monthly Usage: {{ selectedInvestigation.monthly_usage }} kWh</div>
                        <div>Property Type: {{ selectedInvestigation.property_type | titlecase }}</div>
                        <div *ngIf="selectedInvestigation.budget_range">Budget: {{ selectedInvestigation.budget_range }}
                        </div>
                    </div>
                </div>

                <!-- Agent Chat -->
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">AI Agent Communications</h5>
                        <small class="text-muted" *ngIf="chatMessages.length > 0">
                            {{ chatMessages.length }} messages
                        </small>
                    </div>

                    <!-- Chat Messages -->
                    <div class="border rounded p-3 bg-light chat-container"
                        style="max-height: 400px; overflow-y: auto;">
                        <div *ngIf="chatMessages.length === 0" class="text-center py-4">
                            <div style="font-size: 3rem;" class="mb-2">ü§ñ</div>
                            <p class="text-muted">AI agents will appear here when the investigation starts...</p>
                        </div>

                        <div *ngFor="let message of chatMessages" class="d-flex mb-3">
                            <div class="flex-shrink-0 me-3">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                                    style="width: 2rem; height: 2rem;">
                                    <small class="fw-bold">
                                        {{ getMessageAuthor(message).charAt(0).toUpperCase() }}
                                    </small>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <strong class="small">{{ getMessageAuthor(message) }}</strong>
                                    <small class="text-muted ms-2">{{ formatDate(message.timestamp) }}</small>
                                </div>
                                <p class="small mb-0">{{ message.content }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Findings Section -->
                    <div *ngIf="selectedInvestigation.result" class="mt-4">
                        <h6>Investigation Results</h6>
                        <div class="alert alert-success">
                            <pre>{{ selectedInvestigation.result | json }}</pre>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div *ngIf="selectedInvestigation.error_message" class="mt-4">
                        <h6>Error</h6>
                        <div class="alert alert-danger">
                            {{ selectedInvestigation.error_message }}
                        </div>
                    </div>

                    <!-- Action Buttons for Completed Investigations -->
                    <div *ngIf="selectedInvestigation.status === 'completed'" class="mt-4 d-flex gap-2">
                        <button (click)="makeDecision('create_report', 'report')" class="btn btn-primary"
                            [disabled]="isLoading">
                            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                            Create Report
                        </button>
                        <button (click)="makeDecision('create_work_order', 'work_order')" class="btn btn-success"
                            [disabled]="isLoading">
                            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                            Create Work Order
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Work Orders Tab -->
        <div *ngIf="activeTab === 'workorders' && !isLoading">
            <div *ngIf="workOrders.length === 0" class="text-center py-5">
                <div style="font-size: 4rem;" class="text-muted mb-3">üìã</div>
                <h3 class="h4 text-dark mb-3">No work orders found</h3>
                <p class="text-muted">Work orders will appear here when created from investigations.</p>
            </div>
        </div>

        <!-- Projects Tab -->
        <div *ngIf="activeTab === 'projects' && !isLoading">
            <div *ngIf="projects.length === 0" class="text-center py-5">
                <div style="font-size: 4rem;" class="text-muted mb-3">üèóÔ∏è</div>
                <h3 class="h4 text-dark mb-3">No projects found</h3>
                <p class="text-muted">Solar farm projects will appear here once configured.</p>
            </div>
        </div>
    </div>
</div>

<!-- New Investigation Modal -->
<ng-template #newInvestigationModal let-modal>
    <div class="modal-header">
        <h1 class="modal-title fs-5">Start New Solar Investigation</h1>
        <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body">
        <form #investigationForm="ngForm">
            <div class="mb-3">
                <label for="address" class="form-label">Property Address *</label>
                <input type="text" class="form-control" id="address" name="address"
                    [(ngModel)]="newInvestigationForm.address" required
                    placeholder="Enter the property address for solar analysis">
                <div class="form-text">Full address helps with accurate solar potential calculation</div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="monthly_usage" class="form-label">Monthly Usage (kWh) *</label>
                        <input type="number" class="form-control" id="monthly_usage" name="monthly_usage"
                            [(ngModel)]="newInvestigationForm.monthly_usage" required min="0" step="0.1"
                            placeholder="e.g., 850">
                        <div class="form-text">Average monthly electricity usage in kilowatt-hours</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="property_type" class="form-label">Property Type</label>
                        <select class="form-select" id="property_type" name="property_type"
                            [(ngModel)]="newInvestigationForm.property_type">
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                            <option value="industrial">Industrial</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="budget_range" class="form-label">Budget Range (Optional)</label>
                <select class="form-select" id="budget_range" name="budget_range"
                    [(ngModel)]="newInvestigationForm.budget_range">
                    <option value="">Select budget range...</option>
                    <option value="under_10k">Under $10,000</option>
                    <option value="10k_25k">$10,000 - $25,000</option>
                    <option value="25k_50k">$25,000 - $50,000</option>
                    <option value="50k_100k">$50,000 - $100,000</option>
                    <option value="over_100k">Over $100,000</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="additional_notes" class="form-label">Additional Notes (Optional)</label>
                <textarea class="form-control" id="additional_notes" name="additional_notes"
                    [(ngModel)]="newInvestigationForm.additional_notes" rows="3"
                    placeholder="Any specific requirements, constraints, or goals for this solar investigation..."></textarea>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Cancel</button>
        <button type="button" class="btn btn-primary"
            [disabled]="isLoading || !newInvestigationForm.address || !newInvestigationForm.monthly_usage"
            (click)="startNewInvestigation(); modal.close();">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
            Start Investigation
        </button>
    </div>
</ng-template>